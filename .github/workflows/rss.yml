name: OTC RSS mirror

on:
  # ── run every 15 minutes ───────────────────────────
  schedule:
    - cron: "*/15 * * * *"
  # ── allow manual runs from the Actions tab ────────
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # 1. Fetch RSS (force HTTP/1.1; fallback to CDN)
            - name: Fetch RSS (with timeout, HTTP/1.1, fallback insecure)
        run: |
          set -e
          # Try primary (strict TLS), then fallback (skip cert check)
          curl --max-time 20 --retry 3 --retry-delay 5 -sSL --http1.1 \
               -o rss.xml "https://www.otcmarkets.com/syndicate/rss.xml" \
            || curl --max-time 20 --retry 3 --retry-delay 5 --insecure -sSL --http1.1 \
               -o rss.xml "https://content.otcmarkets.com/syndicate/rss.xml"

      # 2. Convert to plain text with a time‑stamp header
      - name: Convert to plain text
        run: |
          {
            echo "OTC RSS mirror fetched: $(date -u)"
            echo
            cat rss.xml
          } > latest_otc_rss.txt

      # 3. Upload as workflow artifact
      - name: Upload artefact
        uses: actions/upload-artifact@v4
        with:
          name: latest_otc_rss.txt
          path: latest_otc_rss.txt
